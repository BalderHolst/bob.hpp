#!/usr/bin/env python3
import os
import subprocess

SRC = "./bob.cpp"
BIN = "./bob"

# Checkout submodules
subprocess.run(["git", "submodule", "update", "--init", "--recursive"], check=True)

# Check documentation
subprocess.run([BIN, "doc", "-e"], check=True)

# Compile the test binary if it does not exist
if not os.path.exists(BIN):
    print(f"Compiling {SRC} to {BIN}...")
    subprocess.run(["g++", SRC, "-o", BIN], check=True)

# Run the test binary
subprocess.run([BIN, "test"], check=True)

# Check for uncommitted changes
status = subprocess.run(["git", "status", "--porcelain"], capture_output=True, text=True)
if status.stdout:
    print("\nUncommitted changes detected. Please commit or stash them before pushing.")
    print(status.stdout)
    exit(1)
